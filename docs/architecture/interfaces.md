# Repository & Service Interfaces

**Purpose**: Define contracts between layers for data access and external integrations.

**Last Updated**: 2025-12-29

---

## Overview

This document defines all interfaces (contracts) for:
- **Repository Interfaces** - Data access contracts (Domain layer)
- **Service Interfaces** - External system contracts (Infrastructure layer)
- **DTOs** - Data transfer objects (Data layer)
- **Provider Organization** - Dependency injection patterns

---

## Repository Interfaces (Domain Layer)

All repository interfaces are defined in `features/shared/domain/repositories/` and represent contracts for accessing app data.

### User Repository

**Location**: `features/shared/domain/repositories/user_repository.dart`

```dart
abstract class UserRepository {
  /// Creates a new user profile
  Future<User> createUser(User user);
  
  /// Gets the current user (single-user app)
  Future<User?> getCurrentUser();
  
  /// Updates user profile
  Future<void> updateUser(User user);
  
  /// Updates available training days
  Future<void> updateAvailableDays(List<String> days);
  
  /// Updates health permissions status
  Future<void> updateHealthPermissions(bool granted);
}
```

---

### Goal Repository

**Location**: `features/shared/domain/repositories/goal_repository.dart`

```dart
abstract class GoalRepository {
  /// Creates a new goal
  Future<Goal> createGoal(Goal goal);
  
  /// Gets a goal by ID
  Future<Goal> getGoal(String id);
  
  /// Gets all goals
  Future<List<Goal>> getGoals();
  
  /// Gets the currently active goal
  Future<Goal?> getActiveGoal();
  
  /// Updates a goal
  Future<void> updateGoal(Goal goal);
  
  /// Updates confidence scores
  Future<void> updateConfidence({
    required String goalId,
    required double confidence,
    required double adherenceScore,
    required double qualityScore,
    required double consistencyScore,
    required double recoveryScore,
  });
  
  /// Deactivates a goal
  Future<void> deactivateGoal(String goalId);
  
  /// Deletes a goal
  Future<void> deleteGoal(String goalId);
}
```

---

### Workout Repository

**Location**: `features/shared/domain/repositories/workout_repository.dart`

```dart
abstract class WorkoutRepository {
  /// Creates a workout
  Future<Workout> createWorkout(Workout workout);
  
  /// Creates multiple workouts (bulk)
  Future<List<Workout>> createWorkouts(List<Workout> workouts);
  
  /// Gets a workout by ID
  Future<Workout> getWorkout(String id);
  
  /// Gets workouts for a goal
  Future<List<Workout>> getWorkoutsForGoal(String goalId);
  
  /// Gets workouts for a date
  Future<List<Workout>> getWorkoutsForDate(DateTime date);
  
  /// Gets workouts for a date range
  Future<List<Workout>> getWorkoutsForDateRange({
    required DateTime startDate,
    required DateTime endDate,
  });
  
  /// Updates a workout
  Future<void> updateWorkout(Workout workout);
  
  /// Logs workout completion
  Future<void> logWorkout({
    required String workoutId,
    required int actualDuration,
    required double? actualDistance,
    required double? actualPace,
    required int rpe,
  });
  
  /// Marks workout as skipped
  Future<void> skipWorkout(String workoutId);
  
  /// Marks workout as missed
  Future<void> markWorkoutMissed(String workoutId);
  
  /// Watches workouts (real-time updates)
  Stream<List<Workout>> watchWorkouts();
  
  /// Watches workouts for a date
  Stream<List<Workout>> watchWorkoutsForDate(DateTime date);
}
```

**Note**: See [implementation_plan.md](file:///Users/rooshi/.gemini/antigravity/brain/bfda5bb8-d054-43d3-b48c-f67de0476436/implementation_plan.md) for complete interfaces for all 8 repositories.

---

## Service Interfaces (Infrastructure Layer)

### AI Service

**Location**: `infrastructure/services/ai_service.dart`

```dart
/// Training plan generated by AI
class TrainingPlan {
  final List<Mesocycle> mesocycles;
  final List<Microcycle> microcycles;
  final List<Workout> workouts;
  
  TrainingPlan({
    required this.mesocycles,
    required this.microcycles,
    required this.workouts,
  });
}

/// AI service for plan generation
abstract class AIService {
  /// Generates a training plan
  Future<TrainingPlan> generatePlan({
    required Goal goal,
    required User user,
  });
  
  /// Adjusts a workout based on feedback
  Future<Workout> adjustWorkout({
    required Workout planned,
    required String userFeedback,
    required int? actualRPE,
  });
  
  /// Generates confidence explanation
  Future<String> explainConfidenceChange({
    required double previousConfidence,
    required double currentConfidence,
    required Map<String, double> factorScores,
  });
}
```

---

### Health Service

**Location**: `infrastructure/services/health_service.dart`

```dart
/// Health service for device integration
abstract class HealthService {
  /// Requests health permissions
  Future<bool> requestPermissions();
  
  /// Checks if permissions are granted
  Future<bool> hasPermissions();
  
  /// Fetches workouts from health platform
  Future<List<Workout>> getWorkouts({
    required DateTime startDate,
    required DateTime endDate,
  });
  
  /// Fetches sleep data
  Future<SleepData?> getSleepData(DateTime date);
  
  /// Fetches HRV
  Future<double?> getHRV(DateTime date);
  
  /// Fetches resting heart rate
  Future<int?> getRHR(DateTime date);
  
  /// Syncs health data to local database
  Future<void> syncHealthData();
}
```

---

### Analytics Service

**Location**: `infrastructure/services/analytics_service.dart`

```dart
abstract class AnalyticsService {
  /// Logs a custom event
  void logEvent(String name, Map<String, dynamic> parameters);
  
  /// Logs a screen view
  void logScreenView(String screenName);
  
  /// Logs an error
  void logError(Object error, StackTrace stackTrace);
  
  /// Sets user properties
  void setUserProperties(Map<String, dynamic> properties);
}
```

---

## Data Transfer Objects (DTOs)

DTOs live in `data/models/` and map between Drift tables and Domain entities.

### DTO Mapping Pattern

```dart
// Extension on DTO for conversion
extension GoalDTOMapper on GoalDTO {
  /// Converts DTO to Domain entity
  Goal toEntity() {
    return Goal(
      id: id.toString(),
      userId: userId.toString(),
      type: GoalType.fromString(type),
      name: name,
      // ... all fields
    );
  }
  
  /// Converts Domain entity to DTO
  static GoalDTO fromEntity(Goal goal) {
    return GoalDTO(
      id: int.parse(goal.id),
      userId: int.parse(goal.userId),
      type: goal.type.toString(),
      name: goal.name,
      // ... all fields
      createdAt: DateTime.now(),
      updatedAt: DateTime.now(),
    );
  }
}
```

### Usage in Repository

```dart
class GoalRepositoryImpl implements GoalRepository {
  final GoalDao _dao;
  
  @override
  Future<Goal> getGoal(String id) async {
    final dto = await _dao.getGoalById(int.parse(id));
    return dto.toEntity(); // DTO → Entity
  }
  
  @override
  Future<void> updateGoal(Goal goal) async {
    final dto = GoalDTOMapper.fromEntity(goal); // Entity → DTO
    await _dao.updateGoal(dto);
  }
}
```

---

## Provider Organization

### Dependency Providers

**Location**: `infrastructure/providers/service_providers.dart`

```dart
// Database
final driftDatabaseProvider = Provider<DriftDatabase>((ref) {
  return DriftDatabase();
});

// Services
final aiServiceProvider = Provider<AIService>((ref) {
  return AIServiceImpl();
});

final healthServiceProvider = Provider<HealthService>((ref) {
  return HealthServiceImpl();
});

final analyticsServiceProvider = Provider<AnalyticsService>((ref) {
  return AnalyticsServiceImpl();
});
```

---

### Repository Providers

**Location**: `data/providers/repository_providers.dart`

```dart
final goalRepositoryProvider = Provider<GoalRepository>((ref) {
  final db = ref.read(driftDatabaseProvider);
  return GoalRepositoryImpl(db.goalDao);
});

final workoutRepositoryProvider = Provider<WorkoutRepository>((ref) {
  final db = ref.read(driftDatabaseProvider);
  return WorkoutRepositoryImpl(db.workoutDao);
});

// ... all 8 repositories
```

---

### Use Case Providers

**Location**: `features/*/application/providers/usecase_providers.dart`

```dart
final calculateConfidenceProvider = Provider<CalculateConfidence>((ref) {
  final goalRepo = ref.read(goalRepositoryProvider);
  final workoutRepo = ref.read(workoutRepositoryProvider);
  final acwrRepo = ref.read(acwrRepositoryProvider);
  return CalculateConfidence(goalRepo, workoutRepo, acwrRepo);
});
```

---

### State Providers

**Location**: `features/*/presentation/providers/*_provider.dart`

```dart
final goalProgressProvider = StateNotifierProvider<GoalProgressNotifier, GoalProgressState>((ref) {
  final calculateConfidence = ref.read(calculateConfidenceProvider);
  return GoalProgressNotifier(calculateConfidence);
});
```

---

## Related Documentation

- **[Error Handling](error_handling.md)** - Failure and exception contracts
- **[System Architecture](system_architecture.md)** - Layer responsibilities
- **[Data Models](../data_models/)** - Entity definitions

---

**Last Updated**: 2025-12-29
